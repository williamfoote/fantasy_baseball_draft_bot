---
title: "Underdog ETL Pipeline"
output: html_document
date: "2023-02-27"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
id_map_2 <- read.csv('id_map_2.csv')
batc <- read.csv("bat_atc_23.csv")
batc <- left_join(batc, id_map_2[, c('POS', 'IDFANGRAPHS', 'UNDERDOG')], by = c('PlayerId' = 'IDFANGRAPHS'))
batc$POS <- with(batc, ifelse(POS %in% c('1B', '2B', '3B', 'C', 'SS'), 'IF',
                              ifelse(POS %in% c('DH', 'OF', 'P'), 'OF', POS)))
patc <- read.csv("pitch_atc_23.csv")
patc <- left_join(patc, id_map_2[, c('POS', 'IDFANGRAPHS', 'UNDERDOG')], by = c('PlayerId' = 'IDFANGRAPHS')) 

underdog <- read.csv('underdog_rankings_raw.csv')

```

```{r}
get_points <- function(x, player_type = 'batter', cats, points) {
  # Takes a dataframe x and calculates the projected fantasy points
  # Based on cats (vector of category names), and points, an n x 1 matrix
  # Corresponding to how many points per category instance. Key-value pairs
  # Of Sorts.
  if (player_type == 'batter') {
    meta <- x %>% 
      select(c('Name', 'Team', 'PlayerId'))
    numeric_cols <- x %>% 
      select(all_of(cats))
    fpts <- as.matrix(numeric_cols) %*% points
  }
  fpts
}

#get_points(batc, cats = c('X1B', 'X2B', 'X3B', 'HR', 'BB', 'HBP', 'RBI', 'R', 'SB'),
           #points = matrix(c(3, 6, 8, 10, 3, 3, 2, 2, 4), ncol = 1))

#get_points(patc, cats = c('W', 'QS', 'SO', 'IP', 'ER'),
           #points = matrix(c(5, 5, 3, 3, -3), ncol = 1))

batc$proj_fpts <- get_points(batc, cats = c('X1B', 'X2B', 'X3B', 'HR', 'BB', 'HBP', 'RBI', 'R', 'SB'),
           points = matrix(c(3, 6, 8, 10, 3, 3, 2, 2, 4), ncol = 1))

patc$proj_fpts <- get_points(patc, cats = c('W', 'QS', 'SO', 'IP', 'ER'),
           points = matrix(c(5, 5, 3, 3, -3), ncol = 1))
```

```{r}
combined_fpts <- rbind(batc[, c('UNDERDOG', 'Name', 'Team', 'proj_fpts', 'POS', 'InterSD', 'InterSK', 'IntraSD')],
      patc[, c('UNDERDOG', 'Name', 'Team', 'proj_fpts', 'POS', 'InterSD', 'InterSK', 'IntraSD')]) %>% 
  distinct(Name, Team, .keep_all = T) %>% 
  arrange(desc(proj_fpts))
combined_fpts$rank <- 1:nrow(combined_fpts)

combined_fpts[113, 'UNDERDOG'] = '5e2a3754-118c-47a7-b81e-51fb0c1ec8f3'
combined_fpts[177, 'UNDERDOG'] = '44b1df17-224b-4fe3-98cd-dae156588aa6'

#write.csv(combined_fpts, 'underdog_BB_mlb_rankings_23.csv')

final <- left_join(combined_fpts, underdog, by = c('UNDERDOG' = 'id'))
write.csv(final, 'underdog_BB_mlb_rankings_23.csv')


```

